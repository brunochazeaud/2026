<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Calendrier Spirale 2026 V5</title>
  <style>
    :root {
      --bg-light: #f5f7fa;
      --weekday: #4a90e2;
      --weekend: #2ecc71;
      --selected: #ff6b6b;
      --today-gold: #fff4d1; /* Or tr√®s clair */
      --text: #2c3e50;
      --panel-bg: rgba(255, 255, 255, 0.95);
      --prio-1: #2ecc71; /* Vert */
      --prio-2: #f1c40f; /* Jaune */
      --prio-3: #e74c3c; /* Rouge */
    }

    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; overflow: hidden; background: var(--bg-light); touch-action: none; }
    #canvas-container { width: 100vw; height: 100vh; display: block; }
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

    /* Boutons d'angles */
    .corner-btn {
      position: fixed; top: 20px; pointer-events: auto;
      background: var(--panel-bg); border: 1.5px solid var(--selected);
      color: var(--selected); padding: 12px; border-radius: 50%;
      cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: all 0.3s; z-index: 100; width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
    }
    .corner-btn:hover { background: var(--selected); color: #fff; }
    #btn-rdv { left: 20px; }
    #btn-table { right: 20px; }
    #btn-today { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); border-radius: 20px; width: auto; padding: 10px 20px; }

    /* Panel de gauche : Mes RDV */
    #rdv-panel {
      position: fixed; top: 0; left: 0; width: 350px; height: 100%;
      background: var(--panel-bg); backdrop-filter: blur(10px);
      border-right: 1px solid var(--selected);
      transform: translateX(-100%); transition: transform 0.3s ease;
      pointer-events: auto; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
    }
    #rdv-panel.open { transform: translateX(0); }

    /* Panel de droite : Dates */
    #table-panel {
      position: fixed; top: 20px; right: 20px; width: 300px; max-height: 85vh;
      background: var(--panel-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--selected); border-radius: 12px;
      transform: translateX(calc(100% + 40px)); transition: transform 0.3s ease;
      pointer-events: auto; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box;
    }
    #table-panel.open { transform: translateX(0); }

    .close-btn { align-self: flex-end; cursor: pointer; background: none; border: none; font-size: 20px; color: var(--text); }

    /* Formulaire RDV avec vraies couleurs d'importance */
    #rdv-form select option[value="1"] { background-color: var(--prio-1); color: white; }
    #rdv-form select option[value="2"] { background-color: var(--prio-2); color: black; }
    #rdv-form select option[value="3"] { background-color: var(--prio-3); color: white; }
    
    #rdv-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
    #rdv-form input, #rdv-form select, #rdv-form textarea, #rdv-form button { padding: 10px; border: 1px solid #ccc; border-radius: 6px; }

    /* L√©gende Jours F√©ri√©s */
    .legend { font-size: 11px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; display: flex; align-items: center; gap: 8px; }
    .legend-box { width: 12px; height: 12px; background: #e74c3c; border-radius: 2px; }

    /* Grille de dates */
    #table-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; font-size: 11px; }
    .table-day { padding: 6px; border: 1px solid #eee; border-radius: 4px; text-align: center; cursor: pointer; background: #fff; position: relative; }
    .table-day.weekend { background: var(--weekend); color: #fff; }
    .table-day.holiday { background: #e74c3c; color: #fff; font-weight: bold; }
    .table-day.today-cell { background: var(--today-gold) !important; color: #b8860b; border: 1px solid #ffd700; font-weight: bold; }
    .table-day.selected-cell { border: 2px solid var(--selected); box-shadow: 0 0 5px var(--selected); }

    /* Optimisation Mobile */
    @media (max-width: 600px) {
      #rdv-panel { width: 100%; }
      #table-panel { width: calc(100% - 40px); right: 20px; top: 80px; }
      .corner-btn { width: 45px; height: 45px; top: 15px; }
    }

    #rdv-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; }
    .rdv-item { background: white; margin-bottom: 10px; padding: 12px; border-radius: 8px; border-left: 6px solid #ccc; cursor: pointer; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .rdv-item.prio-1 { border-left-color: var(--prio-1); }
    .rdv-item.prio-2 { border-left-color: var(--prio-2); }
    .rdv-item.prio-3 { border-left-color: var(--prio-3); }
  </style>
</head>
<body>
  <div id="canvas-container"></div>
  <div id="ui-layer">
    <button class="corner-btn" id="btn-rdv" title="Rendez-vous">üìÖ</button>
    <button class="corner-btn" id="btn-table" title="Dates">üóìÔ∏è</button>
    <button class="corner-btn" id="btn-today">Aujourd'hui</button>

    <div id="rdv-panel">
      <button class="close-btn" id="close-rdv">‚úñ</button>
      <h3>Nouveau RDV</h3>
      <form id="rdv-form">
        <input name="title" placeholder="Titre" required />
        <input name="date" type="date" required />
        <input name="time" type="time" required />
        <select name="priority">
          <option value="1" style="color:var(--prio-1)">Importance : Basse</option>
          <option value="2" style="color:var(--prio-2)">Importance : Moyenne</option>
          <option value="3" style="color:var(--prio-3)">Importance : Haute</option>
        </select>
        <textarea name="description" placeholder="Notes..." rows="2"></textarea>
        <button type="submit" style="background:var(--selected); color:white; font-weight:bold; cursor:pointer; border:none;">Enregistrer</button>
      </form>
      <div id="rdv-list-container"><ul id="rdv-list"></ul></div>
      <button class="btn" onclick="document.getElementById('import-file').click()" style="width:100%; background:none; border:1.5px solid var(--weekday); color:var(--weekday); padding:10px; border-radius:8px; cursor:pointer;">Importer RDV (JSON)</button>
      <input type="file" id="import-file" style="display:none;" accept=".json">
    </div>

    <div id="table-panel">
      <button class="close-btn" id="close-dates">‚úñ</button>
      <h3 style="margin:0 0 10px 0;">Dates 2026</h3>
      <div id="table-grid"></div>
      <div class="legend">
        <div class="legend-box"></div>
        <span>Jours f√©ri√©s (survolez pour le nom)</span>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    const CONFIG = {
      year: 2026, spiralRadius: 28, spiralHeight: 70, turns: 3.5, pointSize: 0.8,
      colors: { weekday: 0x4a90e2, weekend: 0x2ecc71, selected: 0xff6b6b, today: 0xfff4d1 }
    };

    // Mappage des jours f√©ri√©s 2026
    const holidays = {
      '2026-01-01': 'Jour de l\'An', '2026-04-06': 'Lundi de P√¢ques', '2026-05-01': 'F√™te du Travail',
      '2026-05-08': 'Victoire 1945', '2026-05-14': 'Ascension', '2026-05-25': 'Lundi de Pentec√¥te',
      '2026-07-14': 'F√™te Nationale', '2026-08-15': 'Assomption', '2026-11-01': 'Toussaint',
      '2026-11-11': 'Armistice 1918', '2026-12-25': 'No√´l'
    };

    let scene, camera, renderer, controls, raycaster, pointer, instancedMesh;
    let daysData = [], hoveredIndex = -1, selectedIndex = -1, todayIndex = -1;
    let rdvs = JSON.parse(localStorage.getItem('rdv_v5_2026') || '[]');

    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf5f7fa);
      scene.fog = new THREE.FogExp2(0xf5f7fa, 0.008);

      camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(60, 50, 60);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Optimisation performance/nettet√©
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('canvas-container').appendChild(renderer.domElement);

      const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
      scene.add(hemi);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; 
      controls.dampingFactor = 0.05;

      raycaster = new THREE.Raycaster();
      pointer = new THREE.Vector2();

      buildSpiral();
      buildTable();
      renderRDVList();

      // Events
      window.addEventListener('pointermove', onPointer);
      window.addEventListener('click', onClick);
      document.getElementById('rdv-form').addEventListener('submit', addRDV);
      document.getElementById('btn-rdv').addEventListener('click', () => document.getElementById('rdv-panel').classList.add('open'));
      document.getElementById('btn-table').addEventListener('click', () => document.getElementById('table-panel').classList.add('open'));
      document.getElementById('close-rdv').addEventListener('click', () => document.getElementById('rdv-panel').classList.remove('open'));
      document.getElementById('close-dates').addEventListener('click', () => document.getElementById('table-panel').classList.remove('open'));
      document.getElementById('btn-today').addEventListener('click', focusToday);
      document.getElementById('import-file').addEventListener('change', importRDVs);

      animate();
    }

    function buildSpiral() {
      const isLeap = (CONFIG.year % 4 === 0 && CONFIG.year % 100 !== 0) || CONFIG.year % 400 === 0;
      const total = isLeap ? 366 : 365;
      const geo = new THREE.SphereGeometry(CONFIG.pointSize, 16, 16);
      const mat = new THREE.MeshStandardMaterial({ roughness: 0.3, metalness: 0.2 });
      instancedMesh = new THREE.InstancedMesh(geo, mat, total);
      instancedMesh.userData.originalColors = [];

      const dummy = new THREE.Object3D();
      const color = new THREE.Color();
      let cur = new Date(CONFIG.year, 0, 1);
      const todayStr = new Date().toISOString().split('T')[0];

      for (let i = 0; i < total; i++) {
        const t = i / total;
        const angle = t * Math.PI * 2 * CONFIG.turns;
        const x = Math.cos(angle) * CONFIG.spiralRadius;
        const z = Math.sin(angle) * CONFIG.spiralRadius;
        const y = (t * CONFIG.spiralHeight) - (CONFIG.spiralHeight / 2);

        dummy.position.set(x, y, z);
        dummy.updateMatrix();
        instancedMesh.setMatrixAt(i, dummy.matrix);

        const dateStr = cur.toISOString().split('T')[0];
        const isWeekend = cur.getDay() === 0 || cur.getDay() === 6;

        if (dateStr === todayStr) {
          todayIndex = i;
          color.setHex(CONFIG.colors.today);
        } else if (isWeekend) {
          color.setHex(CONFIG.colors.weekend);
        } else {
          color.setHex(CONFIG.colors.weekday);
        }

        instancedMesh.setColorAt(i, color);
        instancedMesh.userData.originalColors.push(color.clone());
        daysData.push({ index: i, dateStr, pos: new THREE.Vector3(x, y, z), month: cur.getMonth(), label: cur.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' }) });
        cur.setDate(cur.getDate() + 1);
      }
      scene.add(instancedMesh);

      // Labels des mois (Style V2.3 Arial)
      const months = ["JANVIER", "F√âVRIER", "MARS", "AVRIL", "MAI", "JUIN", "JUILLET", "AO√õT", "SEPTEMBRE", "OCTOBRE", "NOVEMBRE", "D√âCEMBRE"];
      months.forEach((name, mIdx) => {
        const d = daysData.find(dd => dd.month === mIdx && dd.label.includes('15'));
        if (d) {
          const sprite = createTextSprite(name, 1.3);
          const angle = Math.atan2(d.pos.z, d.pos.x);
          sprite.position.set(d.pos.x + Math.cos(angle) * 7, d.pos.y, d.pos.z + Math.sin(angle) * 7);
          scene.add(sprite);
        }
      });
    }

    function createTextSprite(msg, scale = 1) {
      const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
      canvas.width = 512; canvas.height = 128; ctx.font = 'bold 48px Arial';
      ctx.fillStyle = 'rgba(44,62,80,1)'; ctx.textAlign = 'center'; ctx.fillText(msg, 256, 80);
      const map = new THREE.CanvasTexture(canvas);
      const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map, transparent: true }));
      sprite.scale.set(10 * scale, 2.5 * scale, 1); return sprite;
    }

    function buildTable() {
      const grid = document.getElementById('table-grid'); grid.innerHTML = '';
      const months = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
      const todayStr = new Date().toISOString().split('T')[0];

      months.forEach((mName, mIdx) => {
        const header = document.createElement('div');
        header.style = "grid-column: span 7; font-weight:bold; padding:8px 0; border-bottom:1px solid #eee;";
        header.textContent = mName; grid.appendChild(header);

        ['L', 'M', 'M', 'J', 'V', 'S', 'D'].forEach(d => {
          const dh = document.createElement('div'); dh.style = "text-align:center; font-weight:bold; opacity:0.5;";
          dh.textContent = d; grid.appendChild(dh);
        });

        const first = new Date(CONFIG.year, mIdx, 1).getDay();
        const offset = first === 0 ? 6 : first - 1;
        for (let i = 0; i < offset; i++) grid.appendChild(document.createElement('div'));

        const daysInMonth = new Date(CONFIG.year, mIdx + 1, 0).getDate();
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `2026-${String(mIdx + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const dayEl = document.createElement('div');
          dayEl.className = 'table-day'; dayEl.id = 'td-' + dateStr; dayEl.textContent = d;

          if (holidays[dateStr]) {
            dayEl.classList.add('holiday');
            dayEl.title = holidays[dateStr]; // Tooltip natif
          }
          if (new Date(CONFIG.year, mIdx, d).getDay() % 6 === 0) dayEl.classList.add('weekend');
          if (dateStr === todayStr) dayEl.classList.add('today-cell');

          dayEl.onclick = () => focusDayIndex(daysData.findIndex(dd => dd.dateStr === dateStr));
          grid.appendChild(dayEl);
        }
      });
    }

    function onClick() { if (hoveredIndex !== -1) focusDayIndex(hoveredIndex); }

    function focusDayIndex(index) {
      if (index === -1) return;
      const d = daysData[index];

      // Couleur s√©lection
      if (selectedIndex !== -1 && selectedIndex !== todayIndex) {
        instancedMesh.setColorAt(selectedIndex, instancedMesh.userData.originalColors[selectedIndex]);
      }
      selectedIndex = index;
      instancedMesh.setColorAt(selectedIndex, new THREE.Color(CONFIG.colors.selected));
      instancedMesh.instanceColor.needsUpdate = true;

      // Animation cam√©ra optimis√©e
      const targetPos = new THREE.Vector3(d.pos.x + 15, d.pos.y + 8, d.pos.z + 15);
      let alpha = 0;
      const startPos = camera.position.clone();
      function move() {
        alpha += 0.05;
        camera.position.lerpVectors(startPos, targetPos, alpha);
        controls.target.lerp(d.pos, 0.1);
        controls.update();
        if (alpha < 1) requestAnimationFrame(move);
      }
      move();

      // UI
      document.querySelectorAll('.table-day').forEach(el => el.classList.remove('selected-cell'));
      const tableEl = document.getElementById('td-' + d.dateStr);
      if (tableEl) {
        tableEl.classList.add('selected-cell');
        tableEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      document.getElementById('rdv-form')['date'].value = d.dateStr;
    }

    function addRDV(e) {
      e.preventDefault();
      const fd = new FormData(e.target);
      rdvs.push({ id: Date.now(), title: fd.get('title'), date: fd.get('date'), time: fd.get('time'), priority: fd.get('priority'), description: fd.get('description') });
      localStorage.setItem('rdv_v5_2026', JSON.stringify(rdvs));
      renderRDVList(); e.target.reset();
    }

    function renderRDVList() {
      const list = document.getElementById('rdv-list'); list.innerHTML = '';
      rdvs.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
      rdvs.forEach(r => {
        const li = document.createElement('li'); li.className = `rdv-item prio-${r.priority}`;
        li.innerHTML = `<strong>${r.title}</strong><br><small>üìÖ ${r.date} √† ${r.time}</small><button style="position:absolute; top:5px; right:5px; background:none; border:none; cursor:pointer;" onclick="event.stopPropagation(); deleteRDV(${r.id})">‚úñ</button>`;
        li.onclick = () => focusDayIndex(daysData.findIndex(dd => dd.dateStr === r.date));
        list.appendChild(li);
      });
    }

    function deleteRDV(id) { rdvs = rdvs.filter(r => r.id !== id); localStorage.setItem('rdv_v5_2026', JSON.stringify(rdvs)); renderRDVList(); }

    function importRDVs(e) {
      const reader = new FileReader();
      reader.onload = (ev) => {
        try { rdvs = rdvs.concat(JSON.parse(ev.target.result)); localStorage.setItem('rdv_v5_2026', JSON.stringify(rdvs)); renderRDVList(); }
        catch (err) { alert("Fichier JSON invalide."); }
      };
      reader.readAsText(e.target.files[0]);
    }

    function focusToday() { if (todayIndex !== -1) focusDayIndex(todayIndex); }
    function onPointer(e) { pointer.x = (e.clientX / window.innerWidth) * 2 - 1; pointer.y = -(e.clientY / window.innerHeight) * 2 + 1; }
    function animate() { requestAnimationFrame(animate); controls.update(); raycaster.setFromCamera(pointer, camera); const inter = raycaster.intersectObject(instancedMesh); if (inter.length) hoveredIndex = inter[0].instanceId; else hoveredIndex = -1; document.body.style.cursor = hoveredIndex !== -1 ? 'pointer' : 'default'; renderer.render(scene, camera); }

    window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

    init();
  </script>
</body>
</html>
