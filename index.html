<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Calendrier Spirale 2026 Pro</title>
  <!-- Importation d'une police d'ic√¥nes pour les RDV -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg-light:#f5f7fa;
      --weekday:#4a90e2;
      --weekend:#2ecc71;
      --selected:#ff6b6b;
      --today-gold:#FFD700; /* Or claire */
      --text:#2c3e50;
      --panel-bg:rgba(255,255,255,0.95);
      --prio-1: #2ecc71; /* Vert */
      --prio-2: #f1c40f; /* Jaune */
      --prio-3: #e74c3c; /* Rouge */
    }
    body{margin:0;font-family:'Segoe UI', Arial, sans-serif;overflow:hidden;background:var(--bg-light); touch-action:none;}
    #canvas-container{width:100vw;height:100vh;display:block; position: absolute; top:0; left:0; z-index: 1;}
    #ui-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;}
    
    /* Panel de gauche : RDV */
    #rdv-panel{
      position:fixed; top:0; left:0; width:350px; height:100%;
      background:var(--panel-bg); backdrop-filter:blur(20px);
      border-right:1px solid var(--selected);
      transform:translateX(-100%); transition:transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events:auto; display:flex; flex-direction:column; padding:20px; box-sizing:border-box;
      box-shadow: 10px 0 30px rgba(0,0,0,0.1);
      z-index: 20;
    }
    #rdv-panel.open{transform:translateX(0);}
    
    /* Panel de droite : Dates */
    #table-panel{
      position:fixed; top:20px; right:20px; width:320px; max-height:88vh;
      background:var(--panel-bg); backdrop-filter:blur(20px);
      border:1px solid #ddd; border-radius:16px;
      transform:translateX(calc(100% + 50px)); transition:transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events:auto; display:flex; flex-direction:column; padding:20px; box-sizing:border-box; overflow-y:auto;
      box-shadow: -5px 5px 20px rgba(0,0,0,0.05);
      z-index: 20;
    }
    #table-panel.open{transform:translateX(0);}

    /* Responsive Design */
    @media (max-width: 768px) {
      #rdv-panel { width: 90%; }
      #table-panel { width: 90%; right: 5%; top: 60px; max-height: 80vh; }
      .controls { bottom: 20px; width: 95%; flex-wrap: wrap; justify-content: center;}
      .btn { flex: 1; padding: 10px; font-size: 12px; margin: 2px;}
    }

    .close-btn { align-self:flex-end; cursor:pointer; background:none; border:none; font-size:20px; color:var(--text); padding:5px; opacity: 0.6; transition: 0.2s;}
    .close-btn:hover { opacity: 1; transform: scale(1.1); }
    
    #rdv-form{display:flex; flex-direction:column; gap:10px; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #eee;}
    #rdv-form input, #rdv-form select, #rdv-form textarea { padding:12px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px; background: #fff; transition: 0.2s;}
    #rdv-form input:focus { border-color: var(--selected); outline: none;}
    
    /* Style des options dans le select */
    .opt-prio-1 { color: var(--prio-1); }
    .opt-prio-2 { color: var(--prio-2); }
    .opt-prio-3 { color: var(--prio-3); }

    #rdv-list-container { flex:1; overflow-y:auto; padding-right:5px;}
    .rdv-item { background:white; margin-bottom:12px; padding:15px; border-radius:12px; position:relative; cursor:pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border:1px solid #f0f0f0; transition: transform 0.2s;}
    .rdv-item:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
    
    /* Ic√¥nes d'importance */
    .rdv-icon { margin-right: 8px; font-size: 1.1em; }
    .rdv-item.prio-1 { border-left: 5px solid var(--prio-1); }
    .rdv-item.prio-1 .rdv-icon { color: var(--prio-1); }
    
    .rdv-item.prio-2 { border-left: 5px solid var(--prio-2); }
    .rdv-item.prio-2 .rdv-icon { color: var(--prio-2); }
    
    .rdv-item.prio-3 { border-left: 5px solid var(--prio-3); }
    .rdv-item.prio-3 .rdv-icon { color: var(--prio-3); }

    /* Style de la table Dates */
    #table-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; font-size:12px; margin-top:10px;}
    .table-day{padding:10px 5px; border-radius:8px; text-align:center; cursor:pointer; background:#fff; border:1px solid #eee; transition: 0.2s; position: relative;}
    .table-day:hover { border-color: #bbb; transform: scale(1.05); z-index: 2;}
    
    .table-day.weekend{background:var(--bg-light); color:var(--weekend); font-weight:bold; border: 1px dashed var(--weekend);}
    .table-day.holiday{background:#e74c3c !important; color:#fff !important; font-weight:bold; border: none; box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);}
    
    .table-day.today-cell{background:var(--today-gold); color:#5c4d00; font-weight:800; border: 1px solid #e6c200; box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);}
    .table-day.selected-cell{border:2px solid var(--selected); background:#fff0f0;}

    /* L√©gende */
    .legend { margin-top: 20px; padding-top: 15px; border-top:1px solid #eee; font-size: 12px; color: #666; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .box-holiday { width: 14px; height: 14px; background: #e74c3c; border-radius: 4px; }

    /* Boutons de contr√¥le */
    .controls{position:absolute; bottom:30px; left:50%; transform:translateX(-50%); pointer-events:auto; display:flex; gap:15px; z-index: 15;}
    .btn{background:var(--panel-bg); border:1px solid #ddd; color:#555; padding:12px 24px; border-radius:30px; cursor:pointer; font-weight:600; font-size:14px; transition:all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.08); backdrop-filter: blur(5px);}
    .btn:hover{background:var(--selected); color:#fff; border-color: var(--selected); transform: translateY(-2px);}
    
    /* Bulle informative (Tooltip) personnalis√©e */
    #custom-tooltip {
      position: absolute;
      background: rgba(44, 62, 80, 0.95);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s, transform 0.1s;
      z-index: 100;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      white-space: nowrap;
      transform: translate(-50%, -120%);
    }
    #custom-tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(44, 62, 80, 0.95) transparent transparent transparent;
    }

    /* Toast de notification */
    #toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
      background: #2ecc71; color: white; padding: 10px 20px; border-radius: 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-weight: bold; z-index: 1000;
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #toast.show { transform: translateX(-50%) translateY(0); }
    #toast.error { background: #e74c3c; }
  </style>
</head>
<body>
  <!-- Conteneur 3D -->
  <div id="canvas-container"></div>
  
  <!-- Interface Utilisateur -->
  <div id="ui-layer">
    <!-- Bulle Info -->
    <div id="custom-tooltip"></div>
    
    <!-- Notification Toast -->
    <div id="toast">Message</div>

    <!-- Contr√¥les : Nouvel ordre demand√© -->
    <div class="controls">
      <button class="btn" id="btn-rdv"><i class="fas fa-calendar-check"></i> MES RDV</button>
      <button class="btn" id="btn-today"><i class="fas fa-crosshairs"></i> AUJOURD'HUI</button>
      <button class="btn" id="btn-table"><i class="fas fa-list"></i> DATES</button>
    </div>

    <!-- Panel RDV -->
    <div id="rdv-panel">
      <button class="close-btn" id="close-rdv">‚úñ</button>
      <h2 style="margin:0 0 20px 0; color:var(--text);">Nouveau Rendez-vous</h2>
      <form id="rdv-form">
        <input name="title" placeholder="Titre de l'√©v√©nement" required />
        <input name="date" type="date" required />
        <input name="time" type="time" required />
        <input name="location" placeholder="Lieu (optionnel)" />
        
        <select name="priority" id="priority-select">
          <option value="1" class="opt-prio-1">üü¢ Faible</option>
          <option value="2" class="opt-prio-2">üü° Moyenne</option>
          <option value="3" class="opt-prio-3">üî¥ Haute</option>
        </select>
        
        <textarea name="description" placeholder="Description..." rows="2" style="resize:none;"></textarea>
        <button type="submit" style="background:var(--selected); color:white; font-weight:bold; cursor:pointer; border:none; padding:12px; border-radius:8px; font-size:14px; margin-top:5px;">ENREGISTRER</button>
      </form>
      
      <h3 style="margin-top:10px; font-size:16px;">Mes √âv√©nements</h3>
      <div id="rdv-list-container"><ul id="rdv-list" style="list-style:none; padding:0; margin:0;"></ul></div>
      
      <div style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
        <input type="file" id="import-file" style="display:none;" accept=".json">
        <button class="btn" onclick="document.getElementById('import-file').click()" style="width:100%; border-color:#ccc; font-size:12px;">
          <i class="fas fa-file-import"></i> IMPORTER (JSON)
        </button>
      </div>
    </div>

    <!-- Panel Table Dates -->
    <div id="table-panel">
      <button class="close-btn" id="close-dates">‚úñ</button>
      <h3 style="margin:0 0 15px 0; font-size:18px;">Calendrier 2026</h3>
      <div id="table-grid"></div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="box-holiday"></div>
          <span>Jour f√©ri√© (Survolez pour info)</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  
  <script>
    const CONFIG={
      year:2026, 
      spiralRadius:28, 
      spiralHeight:70, 
      turns:3.5, 
      pointSize:1.0, // Un peu plus gros pour la nettet√©
      colors:{ 
        weekday:0x4a90e2, 
        weekend:0x2ecc71, 
        selected:0xff6b6b, 
        today:0xFFD700 // Code Hexad√©cimal pour l'Or
      }
    };

    let scene, camera, renderer, controls, raycaster, pointer, instancedMesh;
    let daysData=[], hoveredIndex=-1, selectedIndex=-1, todayIndex=-1;
    // On garde le m√™me storage key pour ne pas perdre les donn√©es de l'utilisateur
    let rdvs = JSON.parse(localStorage.getItem('rdv2026_v5') || '[]');

    const holidayMap = {
      '2026-01-01': "Jour de l'An", '2026-04-13': "Lundi de P√¢ques", '2026-05-01': "F√™te du Travail",
      '2026-05-08': "Victoire 1945", '2026-05-21': "Ascension", '2026-06-01': "Lundi de Pentec√¥te",
      '2026-07-14': "F√™te Nationale", '2026-08-15': "Assomption", '2026-11-01': "Toussaint",
      '2026-11-11': "Armistice 1918", '2026-12-25': "No√´l"
    };

    // Syst√®me de Toast simple
    function showToast(msg, isError = false) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = isError ? 'error' : '';
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function init(){
      scene=new THREE.Scene(); 
      scene.background=new THREE.Color(0xf5f7fa);
      // Brouillard subtil pour la profondeur
      scene.fog = new THREE.FogExp2(0xf5f7fa, 0.006);

      camera=new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(60, 50, 60);

      renderer=new THREE.WebGLRenderer({antialias:true, alpha: true});
      renderer.setPixelRatio(window.devicePixelRatio); // Pour la nettet√© sur √©crans Retina
      renderer.setSize(window.innerWidth, window.innerHeight);
      // Am√©lioration du rendu des couleurs
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.physicallyCorrectLights = true;
      
      document.getElementById('canvas-container').appendChild(renderer.domElement);
      
      // √âclairage am√©lior√©
      const hemi=new THREE.HemisphereLight(0xffffff, 0x444444, 1.5); 
      scene.add(hemi);
      
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(50, 100, 50);
      scene.add(dirLight);

      controls=new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.minDistance = 20;
      controls.maxDistance = 150;

      raycaster=new THREE.Raycaster(); pointer=new THREE.Vector2();

      buildSpiral();
      buildStars(); // Ajout de l'ambiance "espace temps"
      buildTable();
      renderRDVList();

      // Gestionnaire d'√©v√©nements
      window.addEventListener('mousemove', onPointer);
      window.addEventListener('click', onClick);
      document.getElementById('rdv-form').addEventListener('submit', addRDV);
      
      // Ouverture des panneaux
      document.getElementById('btn-rdv').addEventListener('click', ()=>document.getElementById('rdv-panel').classList.add('open'));
      document.getElementById('btn-table').addEventListener('click', ()=>document.getElementById('table-panel').classList.add('open'));
      
      // Fermeture des panneaux
      document.getElementById('close-rdv').addEventListener('click', ()=>document.getElementById('rdv-panel').classList.remove('open'));
      document.getElementById('close-dates').addEventListener('click', ()=>document.getElementById('table-panel').classList.remove('open'));
      
      // Actions
      document.getElementById('btn-today').addEventListener('click', focusToday);
      document.getElementById('import-file').addEventListener('change', importRDVs);
      
      animate();
    }

    function buildStars() {
        // Cr√©ation d'un champ d'√©toiles/particules pour l'ambiance
        const starGeo = new THREE.BufferGeometry();
        const starCount = 1000;
        const posArray = new Float32Array(starCount * 3);
        for(let i=0; i<starCount*3; i++) {
            posArray[i] = (Math.random() - 0.5) * 300; // Large dispersion
        }
        starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const starMat = new THREE.PointsMaterial({
            size: 0.7, 
            color: 0xaaaaaa,
            transparent: true,
            opacity: 0.6
        });
        const stars = new THREE.Points(starGeo, starMat);
        scene.add(stars);
    }

    function buildSpiral(){
      const total = 365;
      // Augmentation des segments pour la nettet√© (16 -> 32)
      const geo = new THREE.SphereGeometry(CONFIG.pointSize, 32, 32);
      
      // Mat√©riau plus physique et net
      const mat = new THREE.MeshPhysicalMaterial({
          color: 0xffffff,
          roughness: 0.2,
          metalness: 0.3,
          clearcoat: 0.5,
          clearcoatRoughness: 0.1
      });
      
      instancedMesh = new THREE.InstancedMesh(geo, mat, total);
      instancedMesh.userData.originalColors = [];
      
      const dummy = new THREE.Object3D();
      const color = new THREE.Color();
      let cur = new Date(CONFIG.year, 0, 1);
      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];

      for(let i=0; i<total; i++){
        const t = i/total;
        const angle = t * Math.PI * 2 * CONFIG.turns;
        const x = Math.cos(angle) * CONFIG.spiralRadius;
        const z = Math.sin(angle) * CONFIG.spiralRadius;
        const y = (t * CONFIG.spiralHeight) - (CONFIG.spiralHeight/2);
        
        dummy.position.set(x, y, z); dummy.updateMatrix();
        instancedMesh.setMatrixAt(i, dummy.matrix);

        const isWeekend = cur.getDay() === 0 || cur.getDay() === 6;
        const dateStr = cur.toISOString().split('T')[0];

        if(dateStr === todayStr) {
          todayIndex = i;
          color.setHex(CONFIG.colors.today);
          // Pour le "Aujourd'hui", on va aussi forcer une couleur √©missive plus tard ou via une lumi√®re proche,
          // mais ici on met la base or.
        } else if(isWeekend) {
          color.setHex(CONFIG.colors.weekend);
        } else {
          color.setHex(CONFIG.colors.weekday);
        }

        instancedMesh.setColorAt(i, color);
        instancedMesh.userData.originalColors.push(color.clone());
        daysData.push({ 
            index: i, dateStr: dateStr, pos: new THREE.Vector3(x,y,z),
            monthIndex: cur.getMonth(), fullDate: cur.toLocaleDateString('fr-FR', {day:'numeric', month:'long'})
        });
        cur.setDate(cur.getDate()+1);
      }
      scene.add(instancedMesh);

      // √âtiquettes des mois (Sprite Text)
      const months=["JANVIER","F√âVRIER","MARS","AVRIL","MAI","JUIN","JUILLET","AO√õT","SEPTEMBRE","OCTOBRE","NOVEMBRE","D√âCEMBRE"];
      months.forEach((name, mIdx)=>{
        const d = daysData.find(dd => dd.monthIndex === mIdx && dd.fullDate.includes('15'));
        if(d){
          const sprite = createTextSprite(name, 1.4);
          const angle = Math.atan2(d.pos.z, d.pos.x);
          sprite.position.set(d.pos.x + Math.cos(angle)*8, d.pos.y, d.pos.z + Math.sin(angle)*8);
          scene.add(sprite);
        }
      });
    }

    function createTextSprite(msg, scale=1){
      const canvas=document.createElement('canvas'), ctx=canvas.getContext('2d');
      // Meilleure qualit√© de canvas
      canvas.width=1024; canvas.height=256; 
      ctx.font='bold 90px Arial'; 
      ctx.fillStyle='rgba(44,62,80,1)';
      ctx.textAlign='center'; 
      ctx.textBaseline='middle';
      ctx.fillText(msg, 512, 128);
      
      const map=new THREE.CanvasTexture(canvas);
      const sprite=new THREE.Sprite(new THREE.SpriteMaterial({map, transparent:true}));
      sprite.scale.set(10*scale, 2.5*scale, 1); 
      return sprite;
    }

    function buildTable(){
      const grid = document.getElementById('table-grid'); grid.innerHTML = '';
      const months = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
      const todayStr = new Date().toISOString().split('T')[0];
      const tooltip = document.getElementById('custom-tooltip');

      months.forEach((mName, mIdx) => {
        const header = document.createElement('div');
        header.style = "grid-column: span 7; font-weight:bold; padding:15px 0 5px 0; color:var(--text); font-size:14px; border-bottom:1px solid #eee;";
        header.textContent = mName; grid.appendChild(header);

        ['L','M','M','J','V','S','D'].forEach(d => {
          const dh = document.createElement('div'); dh.style="text-align:center; font-size:10px; color:#999; padding-bottom:5px;";
          dh.textContent = d; grid.appendChild(dh);
        });

        const first = new Date(CONFIG.year, mIdx, 1).getDay();
        const offset = first === 0 ? 6 : first - 1;
        for(let i=0; i<offset; i++) grid.appendChild(document.createElement('div'));

        const daysInMonth = new Date(CONFIG.year, mIdx+1, 0).getDate();
        for(let d=1; d<=daysInMonth; d++){
          const dateStr = `2026-${String(mIdx+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const dayEl = document.createElement('div');
          dayEl.className = 'table-day'; dayEl.id = 'table-day-' + dateStr; dayEl.textContent = d;
          
          // Gestion Tooltip Jours F√©ri√©s
          if(holidayMap[dateStr]) {
            dayEl.classList.add('holiday');
            // √âv√©nements pour la bulle informative
            dayEl.addEventListener('mouseenter', (e) => {
                tooltip.textContent = holidayMap[dateStr];
                tooltip.style.opacity = 1;
                // Positionnement
                const rect = dayEl.getBoundingClientRect();
                tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                tooltip.style.top = rect.top + 'px';
            });
            dayEl.addEventListener('mouseleave', () => {
                tooltip.style.opacity = 0;
            });
          }
          
          const isWeekend = new Date(CONFIG.year, mIdx, d).getDay() % 6 === 0;
          if(isWeekend && !holidayMap[dateStr]) dayEl.classList.add('weekend');
          if(dateStr === todayStr) dayEl.classList.add('today-cell');
          
          dayEl.onclick = () => focusDayIndex(daysData.findIndex(dd => dd.dateStr === dateStr));
          grid.appendChild(dayEl);
        }
      });
    }

    function onClick(){ if(hoveredIndex !== -1) focusDayIndex(hoveredIndex); }

    function focusDayIndex(index){
      if(index === -1) return;
      const d = daysData[index];

      // Couleur selectionn√©e
      if(selectedIndex !== -1 && selectedIndex !== todayIndex){
        instancedMesh.setColorAt(selectedIndex, instancedMesh.userData.originalColors[selectedIndex]);
      }
      selectedIndex = index;
      instancedMesh.setColorAt(selectedIndex, new THREE.Color(CONFIG.colors.selected));
      
      // Rendre le today sp√©cialement brillant si on clique dessus (ou le laisser or)
      if(selectedIndex === todayIndex) {
          instancedMesh.setColorAt(selectedIndex, new THREE.Color(CONFIG.colors.today));
      }
      
      instancedMesh.instanceColor.needsUpdate = true;

      // Mouvement cam√©ra fluide
      const targetPos = new THREE.Vector3(d.pos.x + 15, d.pos.y + 8, d.pos.z + 15);
      let alpha = 0; const startPos = camera.position.clone();
      function move(){
        alpha += 0.05;
        camera.position.lerpVectors(startPos, targetPos, alpha);
        controls.target.lerp(d.pos, 0.1);
        controls.update();
        if(alpha < 1) requestAnimationFrame(move);
      }
      move();

      // Highlight dans la table
      document.querySelectorAll('.table-day').forEach(el => el.classList.remove('selected-cell'));
      const tableEl = document.getElementById('table-day-' + d.dateStr);
      if(tableEl) {
        tableEl.classList.add('selected-cell');
        tableEl.scrollIntoView({behavior:'smooth', block:'center'});
      }
      // Pr√©-remplissage formulaire
      document.getElementById('rdv-form')['date'].value = d.dateStr;
    }

    function addRDV(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const newRDV = {
        id: Date.now(), title: fd.get('title'), date: fd.get('date'), time: fd.get('time'),
        location: fd.get('location'), priority: fd.get('priority'), description: fd.get('description')
      };
      rdvs.push(newRDV);
      localStorage.setItem('rdv2026_v5', JSON.stringify(rdvs));
      renderRDVList(); 
      e.target.reset();
      showToast("Rendez-vous enregistr√© !");
    }

    function renderRDVList(){
      const list = document.getElementById('rdv-list'); list.innerHTML = '';
      // Tri par date
      rdvs.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
      
      rdvs.forEach(r => {
        const li = document.createElement('li');
        li.className = `rdv-item prio-${r.priority}`;
        
        // Mapping des ic√¥nes selon la priorit√© (FontAwesome)
        let iconClass = 'fa-flag';
        if(r.priority == 1) iconClass = 'fa-arrow-down'; // Faible
        if(r.priority == 3) iconClass = 'fa-fire'; // Haute / Urgent
        
        // Utilisation de vraies ic√¥nes couleur
        li.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center;">
                    <i class="fas ${iconClass} rdv-icon"></i>
                    <div>
                        <strong style="font-size:14px;">${r.title}</strong>
                        <br><small style="color:#777;">üìÖ ${new Date(r.date).toLocaleDateString('fr-FR')} √† ${r.time}</small>
                    </div>
                </div>
                <button class="close-btn" style="font-size:16px;" onclick="event.stopPropagation(); deleteRDV(${r.id})">‚úñ</button>
            </div>
        `;
        li.onclick = () => {
            focusDayIndex(daysData.findIndex(dd => dd.dateStr === r.date));
            // Optionnel : fermer le panel sur mobile apr√®s clic
            if(window.innerWidth < 768) document.getElementById('rdv-panel').classList.remove('open');
        };
        list.appendChild(li);
      });
    }

    function deleteRDV(id){
      if(confirm('Supprimer ce rendez-vous ?')) {
          rdvs = rdvs.filter(r => r.id !== id);
          localStorage.setItem('rdv2026_v5', JSON.stringify(rdvs));
          renderRDVList();
          showToast("Rendez-vous supprim√©");
      }
    }

    function importRDVs(e){
      const reader = new FileReader();
      reader.onload = (ev) => {
        try { 
            const imported = JSON.parse(ev.target.result);
            if(Array.isArray(imported)) {
                rdvs = rdvs.concat(imported); 
                localStorage.setItem('rdv2026_v5', JSON.stringify(rdvs)); 
                renderRDVList(); 
                showToast(`${imported.length} RDV import√©s`);
            } else {
                throw new Error("Format invalide");
            }
        } 
        catch(err) { showToast("Erreur lors de l'import", true); }
      };
      reader.readAsText(e.target.files[0]);
    }

    function focusToday(){ 
        if(todayIndex !== -1) {
            focusDayIndex(todayIndex);
            // Petit effet visuel suppl√©mentaire pour aujourd'hui
            const color = new THREE.Color(CONFIG.colors.today);
            // On pourrait ajouter une animation ici si d√©sir√©
        }
    }
    
    function onPointer(e){ pointer.x = (e.clientX/window.innerWidth)*2-1; pointer.y = -(e.clientY/window.innerHeight)*2+1; }

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      
      raycaster.setFromCamera(pointer, camera);
      const inter = raycaster.intersectObject(instancedMesh);
      
      if(inter.length) {
        if(hoveredIndex !== inter[0].instanceId) {
            hoveredIndex = inter[0].instanceId;
            document.body.style.cursor = 'pointer';
        }
      } else {
        hoveredIndex = -1;
        document.body.style.cursor = 'default';
      }
      
      renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
  </script>
</body>
</html>
