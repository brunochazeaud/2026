<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Calendrier Spirale 2026 Pro</title>
  <style>
    :root{
      --bg-light:#f5f7fa;
      --weekday:#4a90e2;
      --weekend:#2ecc71;
      --selected:#ff6b6b;
      --today:#fffde7; /* Or tr√®s clair */
      --text:#2c3e50;
      --panel-bg:rgba(255,255,255,0.92);
      --prio-1: #2ecc71; /* Vert */
      --prio-2: #f1c40f; /* Jaune */
      --prio-3: #e74c3c; /* Rouge */
    }
    body{margin:0;font-family:'Segoe UI', Arial, sans-serif;overflow:hidden;background:var(--bg-light); touch-action:none;}
    #canvas-container{width:100vw;height:100vh;display:block;}
    #ui-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;}
    
    /* Panel de gauche : RDV - Optimis√© mobile */
    #rdv-panel{
      position:fixed; top:0; left:0; width:350px; height:100%;
      background:var(--panel-bg); backdrop-filter:blur(15px);
      border-right:1px solid var(--selected);
      transform:translateX(-100%); transition:transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events:auto; display:flex; flex-direction:column; padding:20px; box-sizing:border-box;
      box-shadow: 5px 0 15px rgba(0,0,0,0.05);
    }
    #rdv-panel.open{transform:translateX(0);}
    
    /* Panel de droite : Dates - Optimis√© mobile */
    #table-panel{
      position:fixed; top:20px; right:20px; width:300px; max-height:85vh;
      background:var(--panel-bg); backdrop-filter:blur(15px);
      border:1px solid var(--selected); border-radius:12px;
      transform:translateX(calc(100% + 40px)); transition:transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      pointer-events:auto; display:flex; flex-direction:column; padding:15px; box-sizing:border-box; overflow-y:auto;
    }
    #table-panel.open{transform:translateX(0);}

    /* Responsive Design */
    @media (max-width: 768px) {
      #rdv-panel { width: 90%; }
      #table-panel { width: 90%; right: 5%; top: 10px; max-height: 80vh; }
      .controls { bottom: 15px; gap: 5px; width: 95%; flex-wrap: wrap; justify-content: center;}
      .btn { padding: 8px 10px; font-size: 11px; }
    }

    .close-btn { align-self:flex-end; cursor:pointer; background:none; border:none; font-size:22px; color:var(--text); padding:5px; }
    
    #rdv-form{display:flex; flex-direction:column; gap:8px; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #ddd;}
    #rdv-form input, #rdv-form select, #rdv-form textarea { padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; background: white;}
    
    /* Couleurs r√©elles dans le s√©lecteur */
    .opt-prio-1 { color: var(--prio-1); font-weight: bold; }
    .opt-prio-2 { color: var(--prio-2); font-weight: bold; }
    .opt-prio-3 { color: var(--prio-3); font-weight: bold; }

    #rdv-list-container { flex:1; overflow-y:auto; }
    .rdv-item { background:white; margin-bottom:10px; padding:12px; border-radius:8px; position:relative; cursor:pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.08);}
    .rdv-item.prio-1 { border-left: 6px solid var(--prio-1); }
    .rdv-item.prio-2 { border-left: 6px solid var(--prio-2); }
    .rdv-item.prio-3 { border-left: 6px solid var(--prio-3); }

    /* Style de la table Dates */
    #table-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:11px;}
    .table-day{padding:6px; border-radius:4px; text-align:center; cursor:pointer; background:#fff; border:1px solid #eee; transition: 0.2s;}
    .table-day.weekend{background:var(--weekend); color:#fff; border: none;}
    .table-day.holiday{background:#e74c3c !important; color:#fff !important; font-weight:bold; border: none;}
    .table-day.today-cell{background:var(--today); color:#b8860b; font-weight:bold; border: 1px solid #f1c40f;}
    .table-day.selected-cell{border:2px solid var(--selected); box-shadow: 0 0 8px var(--selected);}

    /* L√©gende */
    .legend { margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 12px; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .box-holiday { width: 12px; height: 12px; background: #e74c3c; border-radius: 2px; }

    .controls{position:absolute; bottom:25px; left:50%; transform:translateX(-50%); pointer-events:auto; display:flex; gap:12px;}
    .btn{background:var(--panel-bg); border:1px solid var(--selected); color:var(--selected); padding:10px 18px; border-radius:25px; cursor:pointer; font-weight:bold; font-size:13px; transition:all 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.1);}
    .btn:hover{background:var(--selected); color:#fff;}
  </style>
</head>
<body>
  <div id="canvas-container"></div>
  <div id="ui-layer">
    <div class="controls">
      <button class="btn" id="btn-today">AUJOURD'HUI</button>
      <button class="btn" id="btn-rdv">MES RDV</button>
      <button class="btn" id="btn-table">DATES</button>
    </div>

    <div id="rdv-panel">
      <button class="close-btn" id="close-rdv">‚úñ</button>
      <h3 style="margin-top:0;">Nouveau RDV</h3>
      <form id="rdv-form">
        <input name="title" placeholder="Titre de l'√©v√©nement" required />
        <input name="date" type="date" required />
        <input name="time" type="time" required />
        <input name="location" placeholder="Lieu" />
        <select name="priority" id="priority-select">
          <option value="1" class="opt-prio-1">‚óè Importance : Faible</option>
          <option value="2" class="opt-prio-2">‚óè Importance : Moyenne</option>
          <option value="3" class="opt-prio-3">‚óè Importance : Haute</option>
        </select>
        <textarea name="description" placeholder="Description..." rows="2"></textarea>
        <button type="submit" style="background:var(--selected); color:white; font-weight:bold; cursor:pointer; border:none; padding:12px; border-radius:6px;">Enregistrer</button>
      </form>
      <h3>Liste de l'ann√©e</h3>
      <div id="rdv-list-container"><ul id="rdv-list" style="list-style:none; padding:0;"></ul></div>
      <input type="file" id="import-file" style="display:none;" accept=".json">
      <button class="btn" onclick="document.getElementById('import-file').click()" style="width:100%; border-color:#4a90e2; color:#4a90e2; margin-top:10px;">IMPORTER RDV (JSON)</button>
    </div>

    <div id="table-panel">
      <button class="close-btn" id="close-dates">‚úñ</button>
      <h3 style="margin:0 0 10px 0;">Calendrier 2026</h3>
      <div id="table-grid"></div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="box-holiday"></div>
          <span>Jours f√©ri√©s (Survolez pour le nom)</span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    const CONFIG={
      year:2026, spiralRadius:28, spiralHeight:70, turns:3.5, pointSize:0.8,
      colors:{ weekday:0x4a90e2, weekend:0x2ecc71, selected:0xff6b6b, today:0xfffde7 }
    };

    let scene, camera, renderer, controls, raycaster, pointer, instancedMesh;
    let daysData=[], hoveredIndex=-1, selectedIndex=-1, todayIndex=-1;
    let rdvs = JSON.parse(localStorage.getItem('rdv2026_v5') || '[]');

    const holidayMap = {
      '2026-01-01': "Jour de l'An", '2026-04-13': "Lundi de P√¢ques", '2026-05-01': "F√™te du Travail",
      '2026-05-08': "Victoire 1945", '2026-05-21': "Ascension", '2026-06-01': "Lundi de Pentec√¥te",
      '2026-07-14': "F√™te Nationale", '2026-08-15': "Assomption", '2026-11-01': "Toussaint",
      '2026-11-11': "Armistice 1918", '2026-12-25': "No√´l"
    };

    function init(){
      scene=new THREE.Scene(); 
      scene.background=new THREE.Color(0xf5f7fa);
      scene.fog = new THREE.FogExp2(0xf5f7fa, 0.008);

      camera=new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(60, 50, 60);

      renderer=new THREE.WebGLRenderer({antialias:true});
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('canvas-container').appendChild(renderer.domElement);
      
      const hemi=new THREE.HemisphereLight(0xffffff, 0x444444, 1.2); 
      scene.add(hemi);

      controls=new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      raycaster=new THREE.Raycaster(); pointer=new THREE.Vector2();

      buildSpiral();
      buildTable();
      renderRDVList();

      // Events
      window.addEventListener('mousemove', onPointer);
      window.addEventListener('click', onClick);
      document.getElementById('rdv-form').addEventListener('submit', addRDV);
      document.getElementById('btn-rdv').addEventListener('click', ()=>document.getElementById('rdv-panel').classList.add('open'));
      document.getElementById('btn-table').addEventListener('click', ()=>document.getElementById('table-panel').classList.add('open'));
      document.getElementById('close-rdv').addEventListener('click', ()=>document.getElementById('rdv-panel').classList.remove('open'));
      document.getElementById('close-dates').addEventListener('click', ()=>document.getElementById('table-panel').classList.remove('open'));
      document.getElementById('btn-today').addEventListener('click', focusToday);
      document.getElementById('import-file').addEventListener('change', importRDVs);
      
      animate();
    }

    function buildSpiral(){
      const total = 365;
      const geo = new THREE.SphereGeometry(CONFIG.pointSize, 16, 16);
      const mat = new THREE.MeshStandardMaterial({roughness:.3, metalness:.2});
      instancedMesh = new THREE.InstancedMesh(geo, mat, total);
      instancedMesh.userData.originalColors = [];
      
      const dummy = new THREE.Object3D();
      const color = new THREE.Color();
      let cur = new Date(CONFIG.year, 0, 1);
      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];

      for(let i=0; i<total; i++){
        const t = i/total;
        const angle = t * Math.PI * 2 * CONFIG.turns;
        const x = Math.cos(angle) * CONFIG.spiralRadius;
        const z = Math.sin(angle) * CONFIG.spiralRadius;
        const y = (t * CONFIG.spiralHeight) - (CONFIG.spiralHeight/2);
        
        dummy.position.set(x, y, z); dummy.updateMatrix();
        instancedMesh.setMatrixAt(i, dummy.matrix);

        const isWeekend = cur.getDay() === 0 || cur.getDay() === 6;
        const dateStr = cur.toISOString().split('T')[0];

        if(dateStr === todayStr) {
          todayIndex = i;
          color.setHex(CONFIG.colors.today);
        } else if(isWeekend) {
          color.setHex(CONFIG.colors.weekend);
        } else {
          color.setHex(CONFIG.colors.weekday);
        }

        instancedMesh.setColorAt(i, color);
        instancedMesh.userData.originalColors.push(color.clone());
        daysData.push({ 
            index: i, dateStr: dateStr, pos: new THREE.Vector3(x,y,z),
            monthIndex: cur.getMonth(), fullDate: cur.toLocaleDateString('fr-FR', {day:'numeric', month:'long'})
        });
        cur.setDate(cur.getDate()+1);
      }
      scene.add(instancedMesh);

      const months=["JANVIER","F√âVRIER","MARS","AVRIL","MAI","JUIN","JUILLET","AO√õT","SEPTEMBRE","OCTOBRE","NOVEMBRE","D√âCEMBRE"];
      months.forEach((name, mIdx)=>{
        const d = daysData.find(dd => dd.monthIndex === mIdx && dd.fullDate.includes('15'));
        if(d){
          const sprite = createTextSprite(name, 1.3);
          const angle = Math.atan2(d.pos.z, d.pos.x);
          sprite.position.set(d.pos.x + Math.cos(angle)*7, d.pos.y, d.pos.z + Math.sin(angle)*7);
          scene.add(sprite);
        }
      });
    }

    function createTextSprite(msg, scale=1){
      const canvas=document.createElement('canvas'), ctx=canvas.getContext('2d');
      canvas.width=512; canvas.height=128; ctx.font='bold 48px Arial'; ctx.fillStyle='rgba(44,62,80,1)';
      ctx.textAlign='center'; ctx.fillText(msg, 256, 80);
      const map=new THREE.CanvasTexture(canvas);
      const sprite=new THREE.Sprite(new THREE.SpriteMaterial({map, transparent:true}));
      sprite.scale.set(10*scale, 2.5*scale, 1); return sprite;
    }

    function buildTable(){
      const grid = document.getElementById('table-grid'); grid.innerHTML = '';
      const months = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
      const todayStr = new Date().toISOString().split('T')[0];

      months.forEach((mName, mIdx) => {
        const header = document.createElement('div');
        header.style = "grid-column: span 7; font-weight:bold; padding:10px 0 5px 0; color:var(--text); border-bottom:1px solid #eee; margin-top:5px;";
        header.textContent = mName; grid.appendChild(header);

        ['L','M','M','J','V','S','D'].forEach(d => {
          const dh = document.createElement('div'); dh.style="text-align:center; font-weight:bold; font-size:9px; padding-bottom:3px;";
          dh.textContent = d; grid.appendChild(dh);
        });

        const first = new Date(CONFIG.year, mIdx, 1).getDay();
        const offset = first === 0 ? 6 : first - 1;
        for(let i=0; i<offset; i++) grid.appendChild(document.createElement('div'));

        const daysInMonth = new Date(CONFIG.year, mIdx+1, 0).getDate();
        for(let d=1; d<=daysInMonth; d++){
          const dateStr = `2026-${String(mIdx+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const dayEl = document.createElement('div');
          dayEl.className = 'table-day'; dayEl.id = 'table-day-' + dateStr; dayEl.textContent = d;
          
          if(holidayMap[dateStr]) {
            dayEl.classList.add('holiday');
            dayEl.title = holidayMap[dateStr]; // Infobulle
          }
          const isWeekend = new Date(CONFIG.year, mIdx, d).getDay() % 6 === 0;
          if(isWeekend && !holidayMap[dateStr]) dayEl.classList.add('weekend');
          if(dateStr === todayStr) dayEl.classList.add('today-cell');
          
          dayEl.onclick = () => focusDayIndex(daysData.findIndex(dd => dd.dateStr === dateStr));
          grid.appendChild(dayEl);
        }
      });
    }

    function onClick(){ if(hoveredIndex !== -1) focusDayIndex(hoveredIndex); }

    function focusDayIndex(index){
      if(index === -1) return;
      const d = daysData[index];

      if(selectedIndex !== -1 && selectedIndex !== todayIndex){
        instancedMesh.setColorAt(selectedIndex, instancedMesh.userData.originalColors[selectedIndex]);
      }
      selectedIndex = index;
      instancedMesh.setColorAt(selectedIndex, new THREE.Color(CONFIG.colors.selected));
      instancedMesh.instanceColor.needsUpdate = true;

      const targetPos = new THREE.Vector3(d.pos.x + 15, d.pos.y + 8, d.pos.z + 15);
      let alpha = 0; const startPos = camera.position.clone();
      function move(){
        alpha += 0.04;
        camera.position.lerpVectors(startPos, targetPos, alpha);
        controls.target.lerp(d.pos, 0.1);
        controls.update();
        if(alpha < 1) requestAnimationFrame(move);
      }
      move();

      document.querySelectorAll('.table-day').forEach(el => el.classList.remove('selected-cell'));
      const tableEl = document.getElementById('table-day-' + d.dateStr);
      if(tableEl) {
        tableEl.classList.add('selected-cell');
        tableEl.scrollIntoView({behavior:'smooth', block:'center'});
      }
      document.getElementById('rdv-form')['date'].value = d.dateStr;
    }

    function addRDV(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      rdvs.push({
        id: Date.now(), title: fd.get('title'), date: fd.get('date'), time: fd.get('time'),
        location: fd.get('location'), priority: fd.get('priority'), description: fd.get('description')
      });
      localStorage.setItem('rdv2026_v5', JSON.stringify(rdvs));
      renderRDVList(); e.target.reset();
    }

    function renderRDVList(){
      const list = document.getElementById('rdv-list'); list.innerHTML = '';
      rdvs.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
      rdvs.forEach(r => {
        const li = document.createElement('li');
        li.className = `rdv-item prio-${r.priority}`;
        li.innerHTML = `<strong>${r.title}</strong><br><small>üìÖ ${r.date} - ${r.time}</small><button class="close-btn" style="position:absolute; top:5px; right:10px; font-size:14px;" onclick="event.stopPropagation(); deleteRDV(${r.id})">‚úñ</button>`;
        li.onclick = () => focusDayIndex(daysData.findIndex(dd => dd.dateStr === r.date));
        list.appendChild(li);
      });
    }

    function deleteRDV(id){
      rdvs = rdvs.filter(r => r.id !== id);
      localStorage.setItem('rdv2026_v5', JSON.stringify(rdvs));
      renderRDVList();
    }

    function importRDVs(e){
      const reader = new FileReader();
      reader.onload = (ev) => {
        try { rdvs = rdvs.concat(JSON.parse(ev.target.result)); localStorage.setItem('rdv2026_v5', JSON.stringify(rdvs)); renderRDVList(); } 
        catch(err) { alert("Erreur fichier"); }
      };
      reader.readAsText(e.target.files[0]);
    }

    function focusToday(){ if(todayIndex !== -1) focusDayIndex(todayIndex); }
    function onPointer(e){ pointer.x = (e.clientX/window.innerWidth)*2-1; pointer.y = -(e.clientY/window.innerHeight)*2+1; }

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      raycaster.setFromCamera(pointer, camera);
      const inter = raycaster.intersectObject(instancedMesh);
      if(inter.length) hoveredIndex = inter[0].instanceId; else hoveredIndex = -1;
      document.body.style.cursor = hoveredIndex !== -1 ? 'pointer' : 'default';
      renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
  </script>
</body>
</html>
