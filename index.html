<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Calendrier Spirale 2026 V3</title>
  <style>
    :root{
      --bg-light:#f5f7fa;
      --spiral-line:#a0c0ff;
      --weekday:#4a90e2;
      --weekend:#2ecc71;
      --selected:#ff6b6b;
      --today:#f1c40f;
      --text:#2c3e50;
      --panel-bg:rgba(255,255,255,.95);
      --prio-1: #2ecc71;
      --prio-2: #f1c40f;
      --prio-3: #e74c3c;
    }
    body{margin:0;font-family:'Segoe UI',sans-serif;overflow:hidden;background:var(--bg-light);}
    #canvas-container{width:100vw;height:100vh;display:block;}
    #ui-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;}
    
    /* Panel de gauche : Mes RDV */
    #rdv-panel{
      position:fixed; top:0; left:0; width:350px; height:100%;
      background:var(--panel-bg); backdrop-filter:blur(10px);
      border-right:1px solid var(--selected);
      transform:translateX(-100%); transition:transform 0.3s ease;
      pointer-events:auto; display:flex; flex-direction:column; padding:20px; box-sizing:border-box;
    }
    #rdv-panel.open{transform:translateX(0);}
    
    /* Panel de droite : Dates (Hauteur rÃ©duite) */
    #table-panel{
      position:fixed; top:20px; right:20px; width:280px; max-height:85vh;
      background:var(--panel-bg); backdrop-filter:blur(10px);
      border:1px solid var(--selected); border-radius:12px;
      transform:translateX(calc(100% + 40px)); transition:transform 0.3s ease;
      pointer-events:auto; display:flex; flex-direction:column; padding:15px; box-sizing:border-box; overflow-y:auto;
    }
    #table-panel.open{transform:translateX(0);}

    .close-btn { align-self:flex-end; cursor:pointer; background:none; border:none; font-size:18px; color:var(--text); padding:5px; }
    
    #rdv-form{display:flex; flex-direction:column; gap:8px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;}
    #rdv-form input, #rdv-form select, #rdv-form textarea, #rdv-form button { padding:8px; border:1px solid #ccc; border-radius:4px; font-size:13px;}
    
    #rdv-list-container { flex:1; overflow-y:auto; }
    .rdv-item { background:white; margin-bottom:8px; padding:10px; border-radius:6px; border-left:5px solid #ccc; position:relative; cursor:pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    .rdv-item.prio-1 { border-left-color: var(--prio-1); }
    .rdv-item.prio-2 { border-left-color: var(--prio-2); }
    .rdv-item.prio-3 { border-left-color: var(--prio-3); }
    .delete-rdv { position:absolute; top:5px; right:5px; cursor:pointer; color:#ccc; border:none; background:none; font-size:14px; }

    #table-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:3px; font-size:10px;}
    .table-day{padding:5px; border:1px solid #f0f0f0; border-radius:4px; text-align:center; cursor:pointer; background:#fff;}
    .table-day.weekend{color:#aaa;}
    .table-day.holiday{color:#e74c3c; font-weight:bold;}
    .table-day.today-cell{background:var(--today); color:black; font-weight:bold;}
    .table-day.selected-cell{border:2px solid var(--selected); background:#fff5f5;}

    .controls{position:absolute; bottom:20px; left:50%; transform:translateX(-50%); pointer-events:auto; display:flex; gap:10px;}
    .btn{background:var(--panel-bg); border:1px solid var(--selected); color:var(--selected); padding:10px 14px; border-radius:20px; cursor:pointer; font-weight:bold; font-size:13px; transition:all .3s;}
    .btn:hover{background:var(--selected); color:#fff;}
  </style>
</head>
<body>
  <div id="canvas-container"></div>
  <div id="ui-layer">
    <div class="controls">
      <button class="btn" id="btn-today">Aujourd'hui</button>
      <button class="btn" id="btn-rdv">Mes RDV</button>
      <button class="btn" id="btn-table">Dates</button>
    </div>

    <div id="rdv-panel">
      <button class="close-btn" id="close-rdv">âœ–</button>
      <h3>Nouveau Rendez-vous</h3>
      <form id="rdv-form">
        <input name="title" placeholder="Titre" required />
        <input name="date" type="date" required />
        <input name="time" type="time" required />
        <input name="location" placeholder="Lieu" />
        <select name="priority">
          <option value="1">Importance : Faible</option>
          <option value="2">Importance : Moyenne</option>
          <option value="3">Importance : Haute</option>
        </select>
        <textarea name="description" placeholder="Notes..." rows="2"></textarea>
        <button type="submit" style="background:var(--selected); color:white; font-weight:bold; cursor:pointer; border:none;">Ajouter</button>
      </form>
      <h3>Liste des RDV</h3>
      <div id="rdv-list-container"><ul id="rdv-list" style="list-style:none; padding:0;"></ul></div>
      <input type="file" id="import-file" style="display:none;" accept=".json">
      <button class="btn" onclick="document.getElementById('import-file').click()" style="width:100%; border-color:#4a90e2; color:#4a90e2; margin-top:10px;">Importer RDV (JSON)</button>
    </div>

    <div id="table-panel">
      <button class="close-btn" id="close-dates">âœ–</button>
      <h3 style="margin:0 0 10px 0;">Dates 2026</h3>
      <div id="table-grid"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    const CONFIG={
      year:2026, spiralRadius:28, spiralHeight:70, turns:3.5, pointSize:.8,
      colors:{ weekday:0x4a90e2, weekend:0x2ecc71, selected:0xff6b6b, today:0xf1c40f }
    };
    let scene, camera, renderer, controls, raycaster, pointer, instancedMesh;
    let daysData=[], hoveredIndex=-1, selectedIndex=-1, todayIndex=-1;
    let rdvs = JSON.parse(localStorage.getItem('rdv2026_v3') || '[]');

    const joursFeries=['2026-01-01','2026-04-13','2026-05-01','2026-05-08','2026-05-21','2026-06-01','2026-07-14','2026-08-15','2026-11-01','2026-11-11','2026-12-25'];

    function init(){
      scene=new THREE.Scene(); scene.background=new THREE.Color(0xf5f7fa);
      camera=new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(65, 45, 65);
      renderer=new THREE.WebGLRenderer({antialias:true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('canvas-container').appendChild(renderer.domElement);
      
      const hemi=new THREE.HemisphereLight(0xffffff, 0x444444, 1.3); scene.add(hemi);
      controls=new THREE.OrbitControls(camera, renderer.domElement);
      raycaster=new THREE.Raycaster(); pointer=new THREE.Vector2();

      buildSpiral();
      buildTable();
      renderRDVList();

      // Events
      window.addEventListener('mousemove', onPointer);
      window.addEventListener('click', onClick);
      document.getElementById('rdv-form').addEventListener('submit', addRDV);
      document.getElementById('btn-rdv').addEventListener('click', ()=>document.getElementById('rdv-panel').classList.add('open'));
      document.getElementById('btn-table').addEventListener('click', ()=>document.getElementById('table-panel').classList.add('open'));
      document.getElementById('close-rdv').addEventListener('click', ()=>document.getElementById('rdv-panel').classList.remove('open'));
      document.getElementById('close-dates').addEventListener('click', ()=>document.getElementById('table-panel').classList.remove('open'));
      document.getElementById('btn-today').addEventListener('click', focusToday);
      document.getElementById('import-file').addEventListener('change', importRDVs);
      
      animate();
    }

    function buildSpiral(){
      const total = 365;
      const geo = new THREE.SphereGeometry(CONFIG.pointSize, 16, 16);
      const mat = new THREE.MeshStandardMaterial({roughness:.4});
      instancedMesh = new THREE.InstancedMesh(geo, mat, total);
      instancedMesh.userData.originalColors = [];
      
      const dummy = new THREE.Object3D();
      const color = new THREE.Color();
      let cur = new Date(2026, 0, 1);
      const now = new Date();

      for(let i=0; i<total; i++){
        const t = i/total;
        const angle = t * Math.PI * 2 * CONFIG.turns;
        const x = Math.cos(angle) * CONFIG.spiralRadius;
        const z = Math.sin(angle) * CONFIG.spiralRadius;
        const y = (t * CONFIG.spiralHeight) - (CONFIG.spiralHeight/2);
        
        dummy.position.set(x, y, z); dummy.updateMatrix();
        instancedMesh.setMatrixAt(i, dummy.matrix);

        const isWeekend = cur.getDay() === 0 || cur.getDay() === 6;
        color.setHex(isWeekend ? CONFIG.colors.weekend : CONFIG.colors.weekday);
        
        const dateStr = cur.toISOString().split('T')[0];
        if(dateStr === now.toISOString().split('T')[0]) {
          todayIndex = i;
          color.setHex(CONFIG.colors.today);
        }

        instancedMesh.setColorAt(i, color);
        instancedMesh.userData.originalColors.push(color.clone());
        daysData.push({ 
            index: i, 
            dateStr: dateStr, 
            pos: new THREE.Vector3(x,y,z),
            monthIndex: cur.getMonth()
        });
        cur.setDate(cur.getDate()+1);
      }
      scene.add(instancedMesh);

      // Remettre le nom des mois dans la spirale
      const monthNames=["JANVIER","FÃ‰VRIER","MARS","AVRIL","MAI","JUIN","JUILLET","AOÃ›T","SEPTEMBRE","OCTOBRE","NOVEMBRE","DÃ‰CEMBRE"];
      monthNames.forEach((name, mIdx)=>{
        const d = daysData.find(dd => dd.monthIndex === mIdx && dd.dateStr.endsWith('-15'));
        if(d){
          const sprite = createTextSprite(name);
          const angle = Math.atan2(d.pos.z, d.pos.x);
          sprite.position.set(d.pos.x + Math.cos(angle)*8, d.pos.y, d.pos.z + Math.sin(angle)*8);
          scene.add(sprite);
        }
      });
    }

    function createTextSprite(msg){
      const canvas=document.createElement('canvas'); const ctx=canvas.getContext('2d');
      canvas.width=512; canvas.height=128; ctx.font='bold 50px Segoe UI';
      ctx.fillStyle='rgba(44,62,80,0.8)'; ctx.textAlign='center'; ctx.fillText(msg, 256, 80);
      const map=new THREE.CanvasTexture(canvas);
      const sprite=new THREE.Sprite(new THREE.SpriteMaterial({map, transparent:true}));
      sprite.scale.set(10, 2.5, 1); return sprite;
    }

    function buildTable(){
      const grid = document.getElementById('table-grid'); grid.innerHTML = '';
      const months = ["Janvier","FÃ©vrier","Mars","Avril","Mai","Juin","Juillet","AoÃ»t","Septembre","Octobre","Novembre","DÃ©cembre"];
      months.forEach((mName, mIdx) => {
        const header = document.createElement('div');
        header.style = "grid-column: span 7; font-weight:bold; padding:8px 0; color:var(--weekday); border-bottom:1px solid #eee;";
        header.textContent = mName; grid.appendChild(header);

        ['L','M','M','J','V','S','D'].forEach(d => {
          const dh = document.createElement('div'); dh.style="text-align:center; font-weight:bold; font-size:9px;";
          dh.textContent = d; grid.appendChild(dh);
        });

        const first = new Date(2026, mIdx, 1).getDay();
        const offset = first === 0 ? 6 : first - 1;
        for(let i=0; i<offset; i++) grid.appendChild(document.createElement('div'));

        const daysInMonth = new Date(2026, mIdx+1, 0).getDate();
        for(let d=1; d<=daysInMonth; d++){
          const dateStr = `2026-${String(mIdx+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          const dayEl = document.createElement('div');
          dayEl.className = 'table-day'; dayEl.id = 'table-day-' + dateStr; dayEl.textContent = d;
          
          if(joursFeries.includes(dateStr)) dayEl.classList.add('holiday');
          if(dateStr === new Date().toISOString().split('T')[0]) dayEl.classList.add('today-cell');
          
          dayEl.onclick = () => {
            const idx = daysData.findIndex(dd => dd.dateStr === dateStr);
            focusDayIndex(idx);
          };
          grid.appendChild(dayEl);
        }
      });
    }

    function onClick(){
      if(hoveredIndex !== -1) focusDayIndex(hoveredIndex);
    }

    function focusDayIndex(index){
      if(index === -1) return;
      const d = daysData[index];

      // Couleur de sÃ©lection dans la spirale
      if(selectedIndex !== -1){
        instancedMesh.setColorAt(selectedIndex, instancedMesh.userData.originalColors[selectedIndex]);
      }
      selectedIndex = index;
      instancedMesh.setColorAt(selectedIndex, new THREE.Color(CONFIG.colors.selected));
      instancedMesh.instanceColor.needsUpdate = true;

      // Animation camÃ©ra
      const targetPos = new THREE.Vector3(d.pos.x + 15, d.pos.y + 8, d.pos.z + 15);
      let alpha = 0;
      function move(){
        alpha += 0.05;
        camera.position.lerp(targetPos, 0.1);
        controls.target.lerp(d.pos, 0.1);
        controls.update();
        if(alpha < 1.2) requestAnimationFrame(move);
      }
      move();

      // UI
      document.querySelectorAll('.table-day').forEach(el => el.classList.remove('selected-cell'));
      const tableEl = document.getElementById('table-day-' + d.dateStr);
      if(tableEl) {
        tableEl.classList.add('selected-cell');
        tableEl.scrollIntoView({behavior:'smooth', block:'center'});
      }
      document.getElementById('rdv-form')['date'].value = d.dateStr;
    }

    function addRDV(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      rdvs.push({
        id: Date.now(), title: fd.get('title'), date: fd.get('date'), time: fd.get('time'),
        location: fd.get('location'), priority: fd.get('priority'), description: fd.get('description')
      });
      localStorage.setItem('rdv2026_v3', JSON.stringify(rdvs));
      renderRDVList(); e.target.reset();
    }

    function renderRDVList(){
      const list = document.getElementById('rdv-list'); list.innerHTML = '';
      rdvs.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
      rdvs.forEach(r => {
        const li = document.createElement('li');
        li.className = `rdv-item prio-${r.priority}`;
        li.innerHTML = `<strong>${r.title}</strong><br><small>ðŸ“… ${r.date} - ${r.time}</small><button class="delete-rdv" onclick="event.stopPropagation(); deleteRDV(${r.id})">âœ–</button>`;
        li.onclick = () => focusDayIndex(daysData.findIndex(dd => dd.dateStr === r.date));
        list.appendChild(li);
      });
    }

    function deleteRDV(id){
      rdvs = rdvs.filter(r => r.id !== id);
      localStorage.setItem('rdv2026_v3', JSON.stringify(rdvs));
      renderRDVList();
    }

    function importRDVs(e){
      const reader = new FileReader();
      reader.onload = (ev) => {
        try { rdvs = rdvs.concat(JSON.parse(ev.target.result)); localStorage.setItem('rdv2026_v3', JSON.stringify(rdvs)); renderRDVList(); } 
        catch(err) { alert("Format invalide"); }
      };
      reader.readAsText(e.target.files[0]);
    }

    function focusToday(){ if(todayIndex !== -1) focusDayIndex(todayIndex); }
    function onPointer(e){ pointer.x = (e.clientX/window.innerWidth)*2-1; pointer.y = -(e.clientY/window.innerHeight)*2+1; }

    function animate(){
      requestAnimationFrame(animate);
      raycaster.setFromCamera(pointer, camera);
      const inter = raycaster.intersectObject(instancedMesh);
      if(inter.length) hoveredIndex = inter[0].instanceId; else hoveredIndex = -1;
      document.body.style.cursor = hoveredIndex !== -1 ? 'pointer' : 'default';
      renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
  </script>
</body>
</html>
