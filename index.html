<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Calendrier Spirale 2026 Pro</title>
  <style>
    :root{
      --bg-light:#f5f7fa;
      --bg-gradient:linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
      --spiral-line:#a0c0ff;
      --weekday:#4a90e2;
      --weekend:#2ecc71;
      --selected:#ff6b6b;
      --today:#f1c40f;
      --text:#2c3e50;
      --panel-bg:rgba(255,255,255,.95);
      --prio-1: #2ecc71; /* Vert */
      --prio-2: #f1c40f; /* Jaune */
      --prio-3: #e74c3c; /* Rouge */
    }
    body{margin:0;font-family:'Segoe UI',sans-serif;overflow:hidden;background:var(--bg-light);}
    #canvas-container{width:100vw;height:100vh;display:block;}
    #ui-layer{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;}
    
    /* Panel RDV √† gauche - Liste Globale */
    #rdv-panel{position:fixed;top:0;left:0;width:350px;height:100%;background:var(--panel-bg);backdrop-filter:blur(10px);border-right:1px solid var(--selected);transform:translateX(-100%);transition:transform 0.3s;pointer-events:auto;display:flex;flex-direction:column;padding:20px;box-sizing:border-box;box-shadow: 5px 0 15px rgba(0,0,0,0.1);}
    #rdv-panel.open{transform:translateX(0);}
    
    #rdv-form{display:flex;flex-direction:column;gap:8px;margin-bottom: 20px;padding-bottom:15px;border-bottom: 2px solid #eee;}
    #rdv-form input, #rdv-form select, #rdv-form textarea, #rdv-form button { padding:8px; border:1px solid #ccc; border-radius:4px; font-size:13px;}
    
    #rdv-list-container { flex:1; overflow-y:auto; }
    .rdv-item { background:white; margin-bottom:8px; padding:10px; border-radius:6px; border-left:5px solid #ccc; position:relative; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    .rdv-item.prio-1 { border-left-color: var(--prio-1); }
    .rdv-item.prio-2 { border-left-color: var(--prio-2); }
    .rdv-item.prio-3 { border-left-color: var(--prio-3); }
    .delete-rdv { position:absolute; top:5px; right:5px; cursor:pointer; color:#ccc; border:none; background:none; }

    /* Table calendrier √† droite */
    #table-panel{position:fixed;top:0;right:0;width:320px;height:100%;background:var(--panel-bg);backdrop-filter:blur(10px);border-left:1px solid var(--selected);transform:translateX(100%);transition:transform .3s;pointer-events:auto;display:flex;flex-direction:column;padding:20px;box-sizing:border-box;overflow-y:auto;}
    #table-panel.open{transform:translateX(0);}
    #table-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;font-size:11px;}
    .table-day{padding:6px;border:1px solid #eee;border-radius:4px;text-align:center;cursor:pointer;background:#fff;}
    .table-day.weekend{background:#f9f9f9; color:#aaa;}
    .table-day.holiday{background:#ffebee;color:#c62828; font-weight:bold;}
    .table-day.today{background:var(--today);font-weight:bold;}
    .table-day.selected-day{border:2px solid var(--selected);}

    .controls{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);pointer-events:auto;display:flex;gap:10px;}
    .btn{background:var(--panel-bg);border:1px solid var(--selected);color:var(--selected);padding:10px 14px;border-radius:20px;cursor:pointer;font-weight:bold;font-size:13px;transition:all .3s;}
    .btn:hover{background:var(--selected);color:#fff;}
    .import-btn { background: #4a90e2; color: white; border: none; margin-top: 5px;}
  </style>
</head>
<body>
  <div id="canvas-container"></div>
  <div id="ui-layer">
    <div class="controls">
      <button class="btn" id="btn-today">Aujourd'hui</button>
      <button class="btn" id="btn-rdv">Mes RDV</button>
      <button class="btn" id="btn-table">Calendrier</button>
    </div>

    <div id="rdv-panel">
      <button id="close-panel" style="float:right; cursor:pointer; background:none; border:none;">‚úñ</button>
      <h3>Nouveau Rendez-vous</h3>
      <form id="rdv-form">
        <input name="title" placeholder="Titre du RDV" required />
        <input name="date" type="date" required />
        <input name="time" type="time" required />
        <input name="location" placeholder="Lieu" />
        <select name="priority">
          <option value="1">Importance : Faible (Vert)</option>
          <option value="2">Importance : Moyenne (Jaune)</option>
          <option value="3">Importance : Haute (Rouge)</option>
        </select>
        <textarea name="description" placeholder="Notes..." rows="2"></textarea>
        <button type="submit" style="background:var(--selected); color:white; font-weight:bold; cursor:pointer;">Enregistrer</button>
      </form>
      
      <h3>Tous mes RDV</h3>
      <div id="rdv-list-container">
        <ul id="rdv-list" style="list-style:none; padding:0;"></ul>
      </div>
      <input type="file" id="import-file" style="display:none;" accept=".json">
      <button class="btn import-btn" onclick="document.getElementById('import-file').click()">Importer Catalogue (JSON)</button>
    </div>

    <div id="table-panel">
      <button id="close-table-panel" style="float:right; cursor:pointer; background:none; border:none;">‚úñ</button>
      <h3 id="table-title">Calendrier 2026</h3>
      <div id="table-grid"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    // Configuration & Data
    const CONFIG={
      year:2026, spiralRadius:28, spiralHeight:70, turns:3.5, pointSize:.9,
      colors:{ weekday:0x4a90e2, weekend:0x2ecc71, selected:0xff6b6b, today:0xf1c40f }
    };
    let scene, camera, renderer, controls, raycaster, pointer, instancedMesh;
    let daysData=[], hoveredIndex=-1, selectedIndex=-1, todayIndex=-1;
    let rdvs = JSON.parse(localStorage.getItem('rdv2026_v2') || '[]');

    const joursFeries=['2026-01-01','2026-04-13','2026-05-01','2026-05-08','2026-05-21','2026-06-01','2026-07-14','2026-08-15','2026-11-01','2026-11-11','2026-12-25'];

    function init(){
      scene=new THREE.Scene(); scene.background=new THREE.Color(0xf5f7fa);
      camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,0.1,1000);
      camera.position.set(70,40,70);
      renderer=new THREE.WebGLRenderer({antialias:true});
      renderer.setSize(window.innerWidth,window.innerHeight);
      document.getElementById('canvas-container').appendChild(renderer.domElement);
      
      const light=new THREE.HemisphereLight(0xffffff, 0x444444, 1.2); scene.add(light);
      controls=new THREE.OrbitControls(camera,renderer.domElement);
      raycaster=new THREE.Raycaster(); pointer=new THREE.Vector2();

      buildSpiral();
      buildTable();
      renderRDVList();
      requestNotificationPermission();
      setInterval(checkReminders, 60000); // V√©rifie les rappels chaque minute

      // Events
      window.addEventListener('mousemove', onPointer);
      window.addEventListener('click', onClick);
      document.getElementById('rdv-form').addEventListener('submit', addRDV);
      document.getElementById('btn-rdv').addEventListener('click',()=>document.getElementById('rdv-panel').classList.toggle('open'));
      document.getElementById('btn-table').addEventListener('click',()=>document.getElementById('table-panel').classList.toggle('open'));
      document.getElementById('btn-today').addEventListener('click', focusToday);
      document.getElementById('import-file').addEventListener('change', importRDVs);
      
      animate();
    }

    function buildSpiral(){
      const total = 365;
      const geo = new THREE.SphereGeometry(CONFIG.pointSize, 16, 16);
      const mat = new THREE.MeshStandardMaterial({metalness:0.1, roughness:0.5});
      instancedMesh = new THREE.InstancedMesh(geo, mat, total);
      
      const dummy = new THREE.Object3D();
      const color = new THREE.Color();
      let cur = new Date(2026, 0, 1);
      const now = new Date();

      for(let i=0; i<total; i++){
        const t = i/total;
        const angle = t * Math.PI * 2 * CONFIG.turns;
        const x = Math.cos(angle) * CONFIG.spiralRadius;
        const z = Math.sin(angle) * CONFIG.spiralRadius;
        const y = (t * CONFIG.spiralHeight) - (CONFIG.spiralHeight/2);
        
        dummy.position.set(x, y, z);
        dummy.updateMatrix();
        instancedMesh.setMatrixAt(i, dummy.matrix);

        const isWeekend = cur.getDay() === 0 || cur.getDay() === 6;
        color.setHex(isWeekend ? CONFIG.colors.weekend : CONFIG.colors.weekday);
        
        const dateStr = cur.toISOString().split('T')[0];
        if(dateStr === now.toISOString().split('T')[0]) {
          todayIndex = i;
          color.setHex(CONFIG.colors.today);
        }

        instancedMesh.setColorAt(i, color);
        daysData.push({ 
            index: i, 
            dateStr: dateStr, 
            pos: new THREE.Vector3(x,y,z),
            label: cur.toLocaleDateString('fr-FR', {day:'numeric', month:'long'})
        });
        cur.setDate(cur.getDate()+1);
      }
      scene.add(instancedMesh);
    }

    function buildTable(){
      const grid = document.getElementById('table-grid');
      grid.innerHTML = '';
      const months = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];
      
      months.forEach((mName, mIdx) => {
        const header = document.createElement('div');
        header.style = "grid-column: span 7; font-weight:bold; padding:10px 0; color:var(--weekday); border-bottom:1px solid #eee; margin-top:10px;";
        header.textContent = mName + " 2026";
        grid.appendChild(header);

        ['L','M','M','J','V','S','D'].forEach(d => {
          const dayH = document.createElement('div');
          dayH.style = "text-align:center; font-weight:bold; font-size:10px; padding-bottom:5px;";
          dayH.textContent = d;
          grid.appendChild(dayH);
        });

        const firstDay = new Date(2026, mIdx, 1).getDay();
        const offset = firstDay === 0 ? 6 : firstDay - 1;
        for(let i=0; i<offset; i++) grid.appendChild(document.createElement('div'));

        const daysInMonth = new Date(2026, mIdx+1, 0).getDate();
        for(let d=1; d<=daysInMonth; d++){
          const dayEl = document.createElement('div');
          const dateStr = `2026-${String(mIdx+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          dayEl.className = 'table-day';
          dayEl.id = 'table-day-' + dateStr;
          dayEl.textContent = d;
          
          if(joursFeries.includes(dateStr)) dayEl.classList.add('holiday');
          if(new Date(dateStr).getDay()%6===0) dayEl.classList.add('weekend');
          
          dayEl.onclick = () => {
            const idx = daysData.findIndex(dd => dd.dateStr === dateStr);
            focusDayIndex(idx);
          };
          grid.appendChild(dayEl);
        }
      });
    }

    function onClick(){
      if(hoveredIndex !== -1){
        focusDayIndex(hoveredIndex);
        // Ouvre la table automatiquement pour montrer la s√©lection
        document.getElementById('table-panel').classList.add('open');
      }
    }

    function focusDayIndex(index){
      if(index === -1) return;
      const d = daysData[index];
      
      // Animation Cam√©ra
      const targetPos = new THREE.Vector3(d.pos.x + 20, d.pos.y + 10, d.pos.z + 20);
      let step = 0;
      function move(){
        step += 0.05;
        camera.position.lerp(targetPos, 0.1);
        controls.target.lerp(d.pos, 0.1);
        controls.update();
        if(step < 1) requestAnimationFrame(move);
      }
      move();

      // UI Update
      document.querySelectorAll('.table-day').forEach(el => el.classList.remove('selected-day'));
      const tableEl = document.getElementById('table-day-' + d.dateStr);
      if(tableEl) {
        tableEl.classList.add('selected-day');
        tableEl.scrollIntoView({behavior:'smooth', block:'center'});
      }
      
      // Pr√©-remplir le formulaire RDV
      document.getElementById('rdv-form')['date'].value = d.dateStr;
    }

    function addRDV(e){
      e.preventDefault();
      const fd = new FormData(e.target);
      const newRDV = {
        id: Date.now(),
        title: fd.get('title'),
        date: fd.get('date'),
        time: fd.get('time'),
        location: fd.get('location'),
        priority: fd.get('priority'),
        description: fd.get('description'),
        reminded1d: false,
        reminded1h: false
      };
      rdvs.push(newRDV);
      saveAndRefresh();
      e.target.reset();
    }

    function saveAndRefresh(){
      localStorage.setItem('rdv2026_v2', JSON.stringify(rdvs));
      renderRDVList();
    }

    function renderRDVList(){
      const list = document.getElementById('rdv-list');
      list.innerHTML = '';
      // Tri par date
      rdvs.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time));
      
      rdvs.forEach(r => {
        const li = document.createElement('li');
        li.className = `rdv-item prio-${r.priority}`;
        li.innerHTML = `
          <strong>${r.title}</strong><br>
          <small>üìÖ ${r.date} √† ${r.time}</small><br>
          <small>üìç ${r.location || 'N/A'}</small>
          <button class="delete-rdv" onclick="deleteRDV(${r.id})">‚úñ</button>
        `;
        li.onclick = () => {
           const idx = daysData.findIndex(dd => dd.dateStr === r.date);
           focusDayIndex(idx);
        };
        list.appendChild(li);
      });
    }

    function deleteRDV(id){
      rdvs = rdvs.filter(r => r.id !== id);
      saveAndRefresh();
    }

    function importRDVs(e){
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const imported = JSON.parse(event.target.result);
          rdvs = rdvs.concat(imported);
          saveAndRefresh();
          alert("Importation r√©ussie !");
        } catch(err) { alert("Erreur de format JSON"); }
      };
      reader.readAsText(file);
    }

    // Syst√®me de Rappels
    function requestNotificationPermission(){
      if("Notification" in window) Notification.requestPermission();
    }

    function checkReminders(){
      const now = new Date();
      rdvs.forEach(r => {
        const rdvDate = new Date(r.date + 'T' + r.time);
        const diffMs = rdvDate - now;
        const diffHours = diffMs / (1000 * 60 * 60);

        // Rappel 1 jour avant
        if(diffHours <= 24 && diffHours > 23 && !r.reminded1d){
          sendNotification(`Rappel : ${r.title} demain !`);
          r.reminded1d = true;
        }
        // Rappel 1 heure avant
        if(diffHours <= 1 && diffHours > 0 && !r.reminded1h){
          sendNotification(`Rappel : ${r.title} dans 1 heure √† ${r.location}`);
          r.reminded1h = true;
        }
      });
    }

    function sendNotification(msg){
      if(Notification.permission === "granted") new Notification("Calendrier 2026", {body: msg});
      else alert(msg);
    }

    function focusToday(){
        if(todayIndex !== -1) focusDayIndex(todayIndex);
    }

    function onPointer(e){
      pointer.x = (e.clientX/window.innerWidth)*2-1;
      pointer.y = -(e.clientY/window.innerHeight)*2+1;
    }

    function animate(){
      requestAnimationFrame(animate);
      raycaster.setFromCamera(pointer, camera);
      const inter = raycaster.intersectObject(instancedMesh);
      if(inter.length) hoveredIndex = inter[0].instanceId;
      else hoveredIndex = -1;
      
      document.body.style.cursor = hoveredIndex !== -1 ? 'pointer' : 'default';
      renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
  </script>
</body>
</html>
